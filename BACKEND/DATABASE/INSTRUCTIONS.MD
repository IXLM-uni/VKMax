# Руководство к каталогу BACKEND/DATABASE

## 1. Назначение

Каталог `BACKEND/DATABASE` содержит всё, что связано с постоянным хранением данных:

- SQLAlchemy‑модели (`User`, `File`, `Operation`, `Format` и др.);
- инициализацию асинхронного `engine` и `AsyncSession`;
- вспомогательный модуль `alembic.py` для создания таблиц и базового сидинга;
- слой `CACHE_MANAGER` — тонкие менеджеры поверх моделей.

FastAPI и сервисы работают только через сессии и менеджеры, не создают
сырые SQL‑запросы напрямую.

## 2. Основные файлы

- `models.py`
  - Описывает таблицы БД (SQLAlchemy ORM):
    - `User` — пользователи VKMax, метаданные, лимиты, статистика;
    - `File` — загруженные/сгенерированные файлы, путь на диске, формат;
    - `Operation` — операции конвертации (file/website), статусы, связи;
    - `Format` — справочник форматов (тип, расширение, mime, флаги input/output).
  - Используются во всех менеджерах и сервисах.

- `session.py`
  - Создаёт асинхронный `engine` и фабрику сессий `async_session_factory`.
  - Определяет dependency `get_db_session` для FastAPI:
    - роуты получают `AsyncSession` через `Depends(get_db_session)`;
    - сессия закрывается после обработки запроса.

- `alembic.py`
  - Упрощённая обёртка над миграциями для текущего MVP.
  - Ключевые функции:
    - `async create_tables()` — создаёт все таблицы из `models.py`;
    - `async seed_formats()` — заполняет базовый набор форматов (`pdf`, `docx`, `html`, `graph`, `url`).
  - Используется в тестах (`TESTS/conftest.py`) для подготовки тестовой БД.

- `CACHE_MANAGER/`
  - `base_class.py` — базовый manager с общими CRUD‑утилитами.
  - Специализированные менеджеры:
    - `user.py` — операции с пользователями;
    - `files.py` — поиск/создание файлов;
    - `convert.py` — операции конвертаций (file/website), batch‑создание, статусы;
    - `download.py` — вспомогательные функции для скачивания;
    - `format.py` — работа со справочником форматов;
    - `system.py` — агрегированные статистики.

## 3. Использование с FastAPI

- В роутерах `FAST_API/ROUTES/*.py` БД‑сессия всегда берётся через:

  ```python
  async def endpoint(..., session: AsyncSession = Depends(get_db_session)):
      ...
  ```

- Внутри endpoint’ов используется только `CACHE_MANAGER`, а не сырые запросы.

Такое разделение упрощает тестирование и замену БД (SQLite/Postgres).

## 4. Использование в тестах

- `TESTS/conftest.py`:
  - при старте тестовой сессии вызывает `create_tables()` и `seed_formats()`;
  - использует тот же `async_session_factory`, что и приложение.

- Интеграционные и e2e‑тесты могут при необходимости читать/писать в БД напрямую,
  используя `async_session_factory()` внутри своих проверок (например, проверка
  `result_file_id` у операции после конвертации).

Рекомендуемый подход:

- для проверки HTTP‑контрактов опираться только на ответы API;
- для глубоких проверок (состояние `Operation`, `File`) использовать прямой доступ
  к БД в тестах.

## 5. Миграции и дальнейшее развитие

- Текущий `alembic.py` предназначен для простого старта до полноценной интеграции Alembic.
- При подключении Alembic рекомендуется:
  - зафиксировать текущую схему как базовую ревизию;
  - перевести `create_tables/seed_formats` на использование миграций;
  - дополнить инструкцию разделом о миграциях/тегах.